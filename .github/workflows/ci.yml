name: CI
on: [push, pull_request]

env:
  UV_SYSTEM_PYTHON: 1

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-  
          --health-cmd pg_isready  
          --health-interval 10s  
          --health-timeout 5s  
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-  
          --health-cmd "redis-cli ping"  
          --health-interval 10s  
          --health-timeout 5s  
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.9"
    - name: Setup uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "0.4.15"
        enable-cache: true
        cache-dependency-glob: |  
          requirements**.txt  
          pyproject.toml
    - name: Install dependencies
      run: uv pip install -e ".[dev]"
    - name: Lint with ruff
      run: ruff check .
    - name: Format check
      run: ruff format --check .
    - name: Run tests
      env:
        DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost/testdb
        REDIS_URL: redis://localhost:6379
      run: pytest